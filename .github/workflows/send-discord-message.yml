name: Send discord notification
on:
  workflow_dispatch:
     inputs:
       filename:
         description: "Filename"
         type: string
         required: true
       status:
         description: "Status"
         type: string
         required: true

permissions:
  contents: read
  actions: write

defaults:
  run:
    shell: bash

jobs:
  StatusChangeNotifications:
    runs-on: hiero-improvement-proposals-linux-medium
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Extract HIP abstract
        id: extract_abstract
        env:
          FILENAME: ${{ github.event.inputs.filename }}
        run: |
          # Add .md extension if not present
          if [[ "$FILENAME" == *.md ]]; then
            HIP_FILE="HIP/${FILENAME}"
          else
            HIP_FILE="HIP/${FILENAME}.md"
          fi

          # Verify file exists
          if [ ! -f "$HIP_FILE" ]; then
            echo "Error: File $HIP_FILE does not exist"
            echo "abstract=File not found: $HIP_FILE" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Extract the abstract section (text between "## Abstract" and the next "##" heading)
          ABSTRACT=$(sed -n '/^## Abstract$/,/^## /p' "$HIP_FILE" | sed '$d' | tail -n +2 | sed '/^$/d')

          # If abstract is empty, use a default message
          if [ -z "$ABSTRACT" ]; then
            ABSTRACT="No abstract available for this HIP."
          fi

          # Save the abstract to output (escape for GitHub Actions)
          {
            echo "abstract<<EOF"
            echo "$ABSTRACT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

          # Save the filename without extension for URL
          FILENAME_NO_EXT="${FILENAME%.md}"
          echo "filename_no_ext=$FILENAME_NO_EXT" >> "$GITHUB_OUTPUT"

      - name: Discord notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD }}
        uses: step-security/action-discord@e31fd4e664027caad89e85cc4e9166e193dd6d2d # v0.1.5
        with:
          args: |
            # ${{ steps.extract_abstract.outputs.filename_no_ext }} moved into ${{ github.event.inputs.status }} status

            ## About this HIP
            ${{ steps.extract_abstract.outputs.abstract }}

            Read the full HIP here:
            https://hips.hedera.com/hip/${{ steps.extract_abstract.outputs.filename_no_ext }}
