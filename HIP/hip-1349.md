---
hip: 1349
title: Support `safeTransferFrom` through HTS Precompile and Facade Contract
author: Kiran Pachhai (@kpachhai)
working-group: Jake Hall (@jaycoolh), Raphael Messian (@RaphaelMessian)
type: Standards Track
category: Service
needs-hiero-approval: Yes
needs-hedera-review: Yes
status: Draft
discussions-to: https://github.com/hiero-ledger/hiero-improvement-proposals/pull/1349
created: 2025-11-12
updated: 2026-01-29
---

## Abstract

This proposal introduces support for the ERC-721 `safeTransferFrom` function across both the **Hedera Token Service (HTS) Precompiled Contract and the HTS Facade Contract**. The goal is to improve EVM equivalence and developer experience by allowing DApps, wallets, and smart contracts to use standard NFT transfer semantics on Hedera with minimal friction.

The feature will align with the ERC-721 standard, performing the `onERC721Received` callback check for contract recipients and supporting Hedera-specific automatic token association.

## Motivation

Developers expect the standard ERC-721 `safeTransferFrom` function to work on any EVM chain. Its absence in the Hedera ecosystem forces developers to write chain-specific code and prevents direct deployment of existing, audited Ethereum contracts.

While the current HTS precompile supports ERC-20 and ERC-721 interfaces through `transferFrom`, the lack of `safeTransferFrom` limits compatibility with standard tooling such as OpenZeppelin-based contracts, NFT marketplaces, and multi-chain wallets.

Adding support for `safeTransferFrom` via both the precompile `(0x167)` and the facade contract ensures that developers can seamlessly interact with HTS NFTs using standard ERC interfaces, whether by calling the precompile directly or by using a token's EVM address.

## Rationale

This proposal extends the HTS precompile to handle `safeTransferFrom` calls for NFTs, while also exposing the same functionality through the HTS facade contract, ensuring both low-level and user-facing EVM parity.

### Dual Support Design

1. **Precompile Support (0x167)**:

- Direct smart contract calls to the HTS precompile will now recognize the two standard `safeTransferFrom` function selectors.
- The precompile performs ownership and approval checks, auto-association (if possible), and the `onERC721Received` callback for contract recipients.

2. **Facade Contract Support**:

- As with `transferFrom`, `safeTransferFrom` will also be callable through a token's EVM address.
- This allows developers using the standard ERC-721 interface (`IERC721`) to interact directly with HTS tokens without having to reference the precompile address.

This dual implementation ensures compatibility with both tooling-based interaction (via facade) and direct system-level calls (via precompile).

## User Stories

- **As an NFT marketplace developer**, I want to deploy my existing, audited Ethereum contract on Hedera with minimal changes. By supporting the standard `safeTransferFrom` function, I can ensure compatibility with wallets and tools while preventing assets from being locked in contracts that can't handle them.
- **As a gamer using a Web3 application**, I want to receive an in-game NFT reward from the game's smart contract. The transfer should not fail just because my wallet wasn't pre-configured for that specific NFT. The system should handle the association for me automatically.
- **As an EVM developer**, I want to use a standard, safe function to transfer HTS-backed NFTs without needing to write custom logic to handle Hedera's specific token association requirements.

## Specification

### Function Signatures and Selectors

The following tables enumerate all function selectors expected to be recognized for `safeTransferFrom` functionality.

#### HTS System Contract Selectors (0x167)

The HTS system contract at address `0x167` will recognize the following selectors:

| Selector     | Signature                                         | Description                                      |
| ------------ | ------------------------------------------------- | ------------------------------------------------ |
| `0x42842e0e` | `safeTransferFrom(address,address,uint256)`       | Standard ERC-721 safe transfer without data      |
| `0xb88d4fde` | `safeTransferFrom(address,address,uint256,bytes)` | Standard ERC-721 safe transfer with data payload |

#### HRC Facade Contract Selectors (Token EVM Address)

When calling through a token's EVM address (facade contract), the same standard ERC-721 selectors are recognized:

| Selector     | Signature                                         | Description                                          |
| ------------ | ------------------------------------------------- | ---------------------------------------------------- |
| `0x42842e0e` | `safeTransferFrom(address,address,uint256)`       | Routes to HTS precompile for safe transfer           |
| `0xb88d4fde` | `safeTransferFrom(address,address,uint256,bytes)` | Routes to HTS precompile for safe transfer with data |

#### HTS System Contract at 0x16c (HIP-1028)

As specified in [HIP-1028](https://hips.hedera.com/hip/hip-1028), a new system contract address (`0x16c`) is being introduced to support metadata management with breaking struct changes. Although HIP-1028 is not yet enabled on mainnet, this HIP specifies that the `safeTransferFrom` selectors will also be available at the `0x16c` system contract address once HIP-1028 is activated. All existing HTS functions, including the new `safeTransferFrom` functions, will be supported at both `0x167` and `0x16c` addresses:

| Address | Selectors                  | Notes                                              |
| ------- | -------------------------- | -------------------------------------------------- |
| `0x167` | `0x42842e0e`, `0xb88d4fde` | Current HTS system contract                        |
| `0x16c` | `0x42842e0e`, `0xb88d4fde` | New HTS system contract (when HIP-1028 is enabled) |

### Execution Flow

The execution flow for a `safeTransferFrom` call will be as follows:

1. **Authorization Check**
   Verify that `msg.sender` is either the owner or an approved operator for the NFT.
   If not, revert with a standard error.

2. **Association Check and Auto-Association**

- If the recipient account is not associated with the token:
  a. Check if the recipient has available automatic association slots.
  b. If slots exist, perform an automatic association on behalf of the sender.
  c. If not possible, revert the transaction.

3. **Contract Receiver Check**

- If the recipient is a smart contract, invoke `onERC721Received(msg.sender, from, tokenId, data)`.
- If the call reverts or does not return `0x150b7a02`, the entire transaction MUST revert.

4. **Token Transfer**

- Perform a standard `CryptoTransfer` of the NFT from `from` to `to`.
- Ensure the operation is atomic — if any step fails, all effects (including auto-association) are rolled back.

### Interaction with Code Delegation (HIP-1340)

[HIP-1340](https://hips.hedera.com/hip/hip-1340) introduces support for Ethereum's Pectra upgrade and EIP-7702, which enables Externally Owned Accounts (EOAs) to delegate code execution to smart contracts. This fundamentally changes how `safeTransferFrom` behaves when the recipient is an EOA with delegated code.

#### Impact on Contract Receiver Check

With EIP-7702 code delegation enabled:

1. **EOAs with Delegated Code**: An EOA that has delegated to a smart contract will have code associated with its address. When `safeTransferFrom` checks whether the recipient is a contract (typically via `EXTCODESIZE > 0`), an EOA with delegated code will appear as a contract.

2. **`onERC721Received` Callback Requirement**: If the recipient EOA has delegated code, the `safeTransferFrom` function MUST invoke `onERC721Received` on that address. If the delegated contract does not implement `onERC721Received` or returns an incorrect value, the transfer will revert.

3. **Implications for Users**: Users who enable code delegation on their EOAs must ensure the delegated contract implements `IERC721Receiver` if they wish to receive NFTs via `safeTransferFrom`.

### Gas Charging

Gas costs for `safeTransferFrom` operations are calculated using Hedera's system contract gas calculation model. The total gas required consists of:

#### Base Gas Formula

```
Total Gas = Intrinsic Gas + EVM Execution Gas + System Contract Gas
```

Where:

- **Intrinsic Gas** = `21000 + (4 × zero_bytes) + (16 × non_zero_bytes)`
- **EVM Execution Gas** = Gas consumed by EVM opcodes during execution
- **System Contract Gas** = Hedera-specific gas for HTS operations

#### System Contract Gas Calculation

When calling a system contract (precompile), gas is calculated by:

1. Converting the transaction cost in USD to gas using a set conversion rate
2. Adding a 20% surcharge for overhead and variations in gas usage

System contract gas is calculated by converting the underlying HAPI transaction cost to gas:

```
System Contract Gas = ((HAPI_fee_in_tinycents × 1,000,000) / conversion_factor) × 1.20
```

Where:

- `HAPI_fee_in_tinycents` = The cost of the equivalent CryptoTransfer transaction
- `conversion_factor` = 852,000 tinycents per 1,000,000 gas (as of current rates)
- `1.20` = 20% premium for system contract overhead

#### Additional Gas for Auto-Association

When auto-association is triggered during `safeTransferFrom`, additional gas is charged:

```
Auto-Association Gas = ((CryptoUpdate_fee_in_tinycents × 1,000,000) / conversion_factor) × 1.20
```

This additional cost accounts for:

- The `CryptoUpdate` equivalent operation for token association
- State changes to the recipient's account

#### Additional Gas for Contract Callback

When the recipient is a contract (or an EOA with delegated code per HIP-1340), additional gas is consumed for the `onERC721Received` callback:

```
Callback Gas = CALL_gas + callback_execution_gas
```

Where:

- `CALL_gas` = Standard EVM CALL opcode cost (2600 for cold address, 100 for warm)
- `callback_execution_gas` = Gas consumed by the recipient's `onERC721Received` implementation

### Transaction Records and Rollback Behavior

This section describes how transaction records are generated and how rollbacks are presented in the transaction history and explorers.

#### Successful Execution

On successful `safeTransferFrom`:

1. A parent `ContractCall` record is created with `SUCCESS` status
2. Child records are created for:
   - Token association (if auto-association occurred)
   - NFT transfer operation
   - Contract callback execution (if recipient is a contract)
3. All records reference the parent transaction ID

#### Rollback Scenarios

When a `safeTransferFrom` fails after partial execution, the following rollback behaviors apply:

| Failure Point                          | Records Created        | State Changes   | Explorer Display                              |
| -------------------------------------- | ---------------------- | --------------- | --------------------------------------------- |
| Authorization check fails              | Parent record only     | None            | Single failed transaction                     |
| Auto-association fails (no slots)      | Parent record only     | None            | Failed with `TOKEN_NOT_ASSOCIATED_TO_ACCOUNT` |
| `onERC721Received` returns wrong value | Parent + child records | All rolled back | Parent shows `CONTRACT_REVERT_EXECUTED`       |
| `onERC721Received` reverts             | Parent + child records | All rolled back | Parent shows revert reason if available       |
| Insufficient gas mid-execution         | Parent + child records | All rolled back | Parent shows `INSUFFICIENT_GAS`               |

#### Record Structure for Rollback

When a rollback occurs due to callback failure:

```
Parent ContractCall Record:
  - status: CONTRACT_REVERT_EXECUTED
  - contractCallResult: Contains revert reason (if any)

Child Records (for visibility):
  - TokenAssociation: Shows attempted association (rolled back)
  - CryptoTransfer: Shows attempted transfer (rolled back)
  - ContractCall (callback): Shows callback failure details
```

#### Explorer Visibility

Block explorers should display rolled-back transactions as follows:

1. **Parent Transaction**: Marked as failed with appropriate status code
2. **Child Operations**: Listed as "reverted" or "rolled back" with visual indication
3. **Gas Consumed**: Shows actual gas used up to the point of failure
4. **Revert Reason**: Displayed if the callback provided one (e.g., "ERC721: transfer to non ERC721Receiver implementer")

This ensures full transparency for debugging failed transfers, particularly when the `onERC721Received` callback rejects the transfer.

## Backwards Compatibility

This change adds new functionality but does not modify existing behavior.
Existing `transferFrom` and precompile functions continue to behave as before.

Contracts and clients that already interact with HTS tokens using ERC-721 interfaces will benefit from full `safeTransferFrom` support without modification.

## Security Implications

1. **Re-entrancy Risk**: The external `onERC721Received` call must follow the Checks-Effects-Interactions pattern to prevent re-entrancy.
2. **Atomicity**: The entire flow must be atomic. If any step fails (e.g., the `onERC721Received` check reverts), the entire operation must roll back to its original state. This includes rolling back any new token association that was created as part of the transaction.
3. **Code Delegation Considerations (HIP-1340)**: With EIP-7702 support, the assumption that `tx.origin == msg.sender` guarantees an EOA context no longer holds. Contracts relying on this check for security should be reviewed.
4. **Gas Costs**:
   - Auto-association increases gas consumption.
   - Gas estimation logic in SDKs should reflect the additional cost for automatic association and contract callback checks.

## How to Teach This

- Update the documentation to reflect the new capabilities of `safeTransferFrom`.
- Provide examples in SDKs and tutorials showing how a contract can now use the standard `safeTransferFrom` function on an HTS-backed NFT and how it handles association automatically.
- Educate developers that while association is handled automatically where possible, it can still be a reason for transaction failure if the recipient account is not configured to allow it.
- Document the implications of HIP-1340 code delegation on `safeTransferFrom` behavior, emphasizing that EOAs with delegated code must implement `IERC721Receiver`.

## Open Issues

- Should the precompile emit an event if it performs an auto-association during transfer (for better visibility)?
- Finalize the exact error codes returned for various failure scenarios to ensure consistency across SDKs and explorers.

## References

- [HIP-218: Smart Contract interactions with Hedera Token Accounts](https://hips.hedera.com/hip/hip-218)
- [EIP-721: Non-Fungible Token Standard](https://eips.ethereum.org/EIPS/eip-721)
- [HIP-376: Support Approve/Allowance/transferFrom standard calls from ERC20 and ERC721](https://hips.hedera.com/hip/hip-376)
- [HIP-1028: Metadata management via SmartContracts](https://hips.hedera.com/hip/hip-1028)
- [HIP-1340: EOA Code Delegation](https://hips.hedera.com/hip/hip-1340)
- [EIP-7702: Set EOA Account Code](https://eips.ethereum.org/EIPS/eip-7702)

## Copyright/License

This document is licensed under the Apache License, Version 2.0 —
see [LICENSE](../LICENSE) or <https://www.apache.org/licenses/LICENSE-2.0>.
